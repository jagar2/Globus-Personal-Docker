# Use Ubuntu as the base image
FROM ubuntu:latest

# Update package lists
RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y wget bzip2 ca-certificates curl

# Download Miniconda installer
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh

# Install Miniconda
RUN /bin/bash /tmp/miniconda.sh -b -p /opt/miniconda3 && \
    rm /tmp/miniconda.sh

# Add Miniconda to the PATH
ENV PATH /opt/miniconda3/bin:$PATH

# Install Jupyter Notebook
RUN conda install -y jupyter

# Install dependencies for Globus Personal Connect
RUN apt-get install -y libcurl4-openssl-dev libssl-dev uuid-dev

# Download and install Globus Personal Connect
RUN curl -L -O https://downloads.globus.org/globus-connect-personal/linux/stable/globusconnectpersonal-latest.tgz && \
    tar -xzf globusconnectpersonal-latest.tgz && \
    cd globusconnectpersonal*

# Create a new system user
RUN useradd -ms /bin/bash jupyter

# Change to the jupyter user
USER jupyter

# Set the working directory
WORKDIR /home/jupyter

# Expose the Jupyter Notebook port
EXPOSE 8888

# Command to run Jupyter Notebook and setup Globus Personal Connect
CMD ["bash", "-c", "./globusconnectpersonal -setup"]